# Service å±‚å®ç°è¯´æ˜

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. Service å±‚å®ç°
åˆ›å»ºäº† `internal/service/scheduler.go`ï¼Œå®ç°äº†æ‰€æœ‰ 11 ä¸ª gRPC/HTTP æ¥å£ï¼š

**ä»»åŠ¡ç®¡ç†**ï¼š
- `CreateTask` - åˆ›å»ºä»»åŠ¡
- `GetTask` - è·å–ä»»åŠ¡è¯¦æƒ…
- `UpdateTask` - æ›´æ–°ä»»åŠ¡
- `DeleteTask` - åˆ é™¤ä»»åŠ¡
- `ListTasks` - ä»»åŠ¡åˆ—è¡¨æŸ¥è¯¢

**ä»»åŠ¡æ‰§è¡Œ**ï¼š
- `ExecuteTask` - ç«‹å³æ‰§è¡Œä»»åŠ¡
- `PauseTask` - æš‚åœä»»åŠ¡
- `ResumeTask` - æ¢å¤ä»»åŠ¡

**æ‰§è¡Œå†å²**ï¼š
- `GetTaskExecutions` - è·å–ä»»åŠ¡æ‰§è¡Œå†å²
- `GetExecution` - è·å–æ‰§è¡Œè¯¦æƒ…
- `CancelExecution` - å–æ¶ˆæ‰§è¡Œ

### 2. Biz å±‚å®ç°
- `internal/biz/task_usecase.go` - ä»»åŠ¡ä¸šåŠ¡é€»è¾‘
- `internal/biz/execution_usecase.go` - æ‰§è¡Œè®°å½•ä¸šåŠ¡é€»è¾‘

### 3. ä¾èµ–æ³¨å…¥é…ç½®
å·²å®Œæˆ Wire é…ç½®æ›´æ–°ï¼š
- âœ… `internal/biz/biz.go` - æ³¨å†Œ TaskUsecase å’Œ ExecutionUsecase
- âœ… `internal/service/service.go` - æ³¨å†Œ SchedulerService
- âœ… `internal/server/grpc.go` - æ³¨å†Œ gRPC æœåŠ¡
- âœ… `internal/server/http.go` - æ³¨å†Œ HTTP æœåŠ¡
- âœ… Wire è‡ªåŠ¨ç”Ÿæˆä¾èµ–æ³¨å…¥ä»£ç 

### 4. ç±»å‹è½¬æ¢
å®ç°äº†å®Œæ•´çš„ç±»å‹è½¬æ¢å‡½æ•°ï¼š
- `toTaskReply` - biz.Task â†’ pb.TaskReply
- `toExecutionReply` - biz.TaskExecution â†’ pb.ExecutionReply
- `parseTaskType` - biz.TaskType â†’ pb.TaskType
- `parseTaskStatus` - biz.TaskStatus â†’ pb.TaskStatus
- `parseExecutionStatus` - biz.ExecutionStatus â†’ pb.ExecutionStatus

## ğŸ¯ æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           gRPC/HTTP å®¢æˆ·ç«¯è¯·æ±‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Service å±‚ (scheduler.go)                â”‚
â”‚  - æ¥æ”¶è¯·æ±‚ï¼Œå‚æ•°éªŒè¯                        â”‚
â”‚  - ç±»å‹è½¬æ¢ (pb â†” biz)                      â”‚
â”‚  - è°ƒç”¨ Usecase                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Biz å±‚ (task_usecase.go)                â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘å¤„ç†                              â”‚
â”‚  - çŠ¶æ€ç®¡ç†                                  â”‚
â”‚  - è°ƒç”¨ Repo                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Data å±‚ (task.go)                        â”‚
â”‚  - æ•°æ®åº“æ“ä½œ                                â”‚
â”‚  - ç±»å‹è½¬æ¢ (DB â†” biz)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨æœåŠ¡
```bash
# 1. ç¡®ä¿æ•°æ®åº“å·²åˆå§‹åŒ–
mysql -u root -p < scripts/init_db.sql

# 2. é…ç½®æ•°æ®åº“è¿æ¥ (configs/config.yaml)
data:
  database:
    source: "root:password@tcp(127.0.0.1:3306)/heytom_scheduler?charset=utf8mb4&parseTime=True&loc=Local"

# 3. å¯åŠ¨æœåŠ¡
go run ./cmd/heytom-scheduler
```

### HTTP æ¥å£æµ‹è¯•

**åˆ›å»ºä»»åŠ¡**ï¼š
```bash
curl -X POST http://localhost:8000/api/v1/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•ä»»åŠ¡",
    "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä»»åŠ¡",
    "type": 3,
    "schedule": "0 */5 * * * *",
    "handler": "test_handler",
    "payload": "{\"key\":\"value\"}",
    "timeout": 300
  }'
```

**è·å–ä»»åŠ¡åˆ—è¡¨**ï¼š
```bash
curl http://localhost:8000/api/v1/tasks?page=1&page_size=10
```

**è·å–ä»»åŠ¡è¯¦æƒ…**ï¼š
```bash
curl http://localhost:8000/api/v1/tasks/1
```

**ç«‹å³æ‰§è¡Œä»»åŠ¡**ï¼š
```bash
curl -X POST http://localhost:8000/api/v1/tasks/1/execute \
  -H "Content-Type: application/json" \
  -d '{}'
```

## ğŸ”„ ä¾èµ–æ³¨å…¥æµç¨‹

Wire ä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹ä¾èµ–å…³ç³»ï¼š

```
NewData (GORM DB)
    â†“
NewTaskRepo, NewExecutionRepo
    â†“
NewTaskUsecase, NewExecutionUsecase
    â†“
NewSchedulerService
    â†“
NewGRPCServer, NewHTTPServer
```

## âœ¨ ç‰¹æ€§

1. **åŒåè®®æ”¯æŒ** - åŒæ—¶æ”¯æŒ gRPC å’Œ HTTPï¼Œè‡ªåŠ¨è·¯ç”±è½¬æ¢
2. **ç±»å‹å®‰å…¨** - å®Œæ•´çš„ç±»å‹è½¬æ¢ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯
3. **ä¾èµ–æ³¨å…¥** - ä½¿ç”¨ Wire è‡ªåŠ¨ç®¡ç†ä¾èµ–
4. **æ—¥å¿—è®°å½•** - æ‰€æœ‰å…³é”®æ“ä½œéƒ½æœ‰æ—¥å¿—
5. **é”™è¯¯å¤„ç†** - è§„èŒƒçš„é”™è¯¯ä¼ é€’å’Œå¤„ç†

## ğŸš€ ä¸‹ä¸€æ­¥

- [ ] å®ç°ä»»åŠ¡è°ƒåº¦æ ¸å¿ƒé€»è¾‘
- [ ] æ·»åŠ  Cron è¡¨è¾¾å¼è§£æ
- [ ] å®ç°ä»»åŠ¡æ‰§è¡Œå¼•æ“
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ·»åŠ  Prometheus ç›‘æ§æŒ‡æ ‡
